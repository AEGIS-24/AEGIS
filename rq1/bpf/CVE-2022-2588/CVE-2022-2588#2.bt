#include <linux/rtnetlink.h>

BEGIN {
    printf("Monitoring for CVE-2022-2588 exploitation attempts...\n");
}

// Monitor Netlink filter addition (RTM_NEWTFILTER)
tracepoint:syscalls:sys_enter_sendmsg
/args->msg->msg_iovlen > 0 && ((struct nlmsghdr *)args->msg->msg_iov->iov_base)->nlmsg_type == RTM_NEWTFILTER/
{
    @filter_add_state[tid] = RTM_NEWTFILTER;
}

// Monitor Netlink filter deletion (RTM_DELTFILTER)
tracepoint:syscalls:sys_enter_sendmsg
/args->msg->msg_iovlen > 0 && @filter_add_state[tid] == RTM_NEWTFILTER && ((struct nlmsghdr *)args->msg->msg_iov->iov_base)->nlmsg_type == RTM_DELTFILTER/
{
    @filter_add_state[tid] = RTM_DELTFILTER;
}

// Detect potential exploitation (filter deleted but not removed from hashtable due to handle 0 condition)
tracepoint:syscalls:sys_enter_recvmsg
/@filter_add_state[tid] == RTM_DELTFILTER/
{
    printf("CVE-2022-2588 maybe triggered by pid[%d] comm[%s]\n", pid, comm);
    delete(@filter_add_state[tid]);
}