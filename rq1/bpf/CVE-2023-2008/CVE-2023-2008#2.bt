// Monitoring system call sequence to detect exploitation attempt of CVE-2023-2008
BEGIN
{
    clear(@syscall_seq);
}

tracepoint:syscalls:sys_enter_memfd_create
{
    // Detect the first step: Create an anonymous memory-backed file
    @syscall_seq[pid] = 1;
}

tracepoint:syscalls:sys_enter_ioctl
/@syscall_seq[pid] == 1/
{
    // Detect the second step: Issue IOCTLs to the vulnerable udmabuf device
    @syscall_seq[pid] = 2;
}

tracepoint:syscalls:sys_enter_vmsplice
/@syscall_seq[pid] == 2/
{
    // Detect the third step: Perform heap spraying using pipes and vmsplice
    @syscall_seq[pid] = 3;
}

tracepoint:syscalls:sys_enter_mremap
/@syscall_seq[pid] == 3/
{
    // Detect the final step: Trigger mremap for out-of-bounds memory access
    printf("CVE-2023-2008 maybe triggered by pid[%d] comm[%s]\n", pid, comm);
    // Reset sequence after detection to avoid repetitive alerts
    delete(@syscall_seq[pid]);
}