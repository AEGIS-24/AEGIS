tracepoint:syscalls:sys_enter_openat
/ args->flags == 0 /
{
    @ro_file[pid] = args->dfd;
}

tracepoint:syscalls:sys_enter_pipe
{
    @pipefds[pid] = args->fildes;
}

tracepoint:syscalls:sys_enter_splice
/ @ro_file[pid] == args->fd_in && @pipefds[pid][1] == args->fd_out /
{
    @splice_active[pid] = 1;
}

tracepoint:syscalls:sys_enter_write
/ @splice_active[pid] == 1 && @pipefds[pid][1] == args->fd /
{
    printf("CVE-2022-0847 maybe triggered by pid[%d] comm[%s]\n", pid, comm);
    delete(@splice_active[pid]);
    delete(@ro_file[pid]);
    delete(@pipefds[pid]);
}

tracepoint:raw_syscalls:sys_exit
{
    delete(@ro_file[pid]);
    delete(@pipefds[pid]);
    delete(@splice_active[pid]);
}