tracepoint:syscalls:sys_enter_mmap
/ args->flags & (0x20 | 0x02) / // MAP_ANONYMOUS is 0x20 and MAP_PRIVATE is 0x02
{
    @mmap_flag[pid]++;
}

tracepoint:syscalls:sys_enter_madvise
/ args->behavior == 4 / // MADV_DONTNEED is 4
{
    @madvise_cnt[pid]++;
}

tracepoint:syscalls:sys_enter_openat
/ str(args->filename) == "/proc/self/mem" /
{
    @procselfmem_flag[pid]++;
}

tracepoint:syscalls:sys_enter_write
/ @procselfmem_flag[pid] > 0 /
{
    @write_cnt[pid]++;
}

tracepoint:syscalls:sys_enter_write
/ @mmap_flag[pid] > 0 && @madvise_cnt[pid] > 0 && @write_cnt[pid] > 0 /
{
    printf("CVE-2017-1000405 maybe triggered by pid[%d] comm[%s]\n", pid, comm);
    delete(@mmap_flag[pid]);
    delete(@madvise_cnt[pid]);
    delete(@write_cnt[pid]);
}

interval:s:1 
{
    clear(@mmap_flag);
    clear(@madvise_cnt);
    clear(@write_cnt);
    clear(@procselfmem_flag);
}