#include <linux/openvswitch.h>
#include <linux/socket.h>
#include <linux/netlink.h>

tracepoint:syscalls:sys_enter_socket
/args->family == AF_NETLINK && args->protocol == NETLINK_GENERIC/
{
    @netlink_sockets[pid] = 1;  // Mark this process as using netlink
}

tracepoint:syscalls:sys_enter_sendto
/@netlink_sockets[pid] == 1/
{
    // Capture netlink communication related to OpenvSwitch (OVS)
    $ovs_flow_family_id = 1;    // OVS_FLOW_FAMILY_VALUE placeholder
    $action_attr_userspace = OVS_ACTION_ATTR_USERSPACE;

    // Look for large netlink message sizes that might trigger the vulnerability
    if (args->len > 0xff00) {
        printf("CVE-2022-2639 maybe triggered by pid[%d] comm[%s]\n", pid, comm);
    }
}

tracepoint:syscalls:sys_exit_close
/@netlink_sockets[pid]/
{
    // Remove tracked process when socket is closed
    delete(@netlink_sockets[pid]);
}